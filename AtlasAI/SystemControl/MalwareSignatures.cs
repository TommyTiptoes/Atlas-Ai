using System;
using System.Collections.Generic;
using System.Security.Cryptography;
using System.IO;
using System.Linq;

namespace MinimalApp.SystemControl
{
    /// <summary>
    /// Real malware signature database with known threat hashes and patterns
    /// </summary>
    public static class MalwareSignatures
    {
        // Known malware file hashes (SHA256) - real signatures
        public static readonly HashSet<string> KnownMalwareHashes = new(StringComparer.OrdinalIgnoreCase)
        {
            // Emotet samples
            "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
            // WannaCry
            "ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa",
            // Petya/NotPetya
            "027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745",
        };

        // Known malware process names - EXACT matches only
        public static readonly HashSet<string> MalwareProcessNames = new(StringComparer.OrdinalIgnoreCase)
        {
            "darkcomet", "njrat", "nanocore", "quasar", "asyncrat", "remcos",
            "orcus", "luminosity", "blackshades", "poisonivy",
            "xmrig", "cryptonight",
            "emotet", "trickbot", "dridex", "qakbot",
            "wannacry", "petya", "notpetya", "locky", "cerber", "cryptolocker",
        };

        // Whitelist - legitimate Windows/system files that should NEVER be flagged
        private static readonly HashSet<string> WhitelistPatterns = new(StringComparer.OrdinalIgnoreCase)
        {
            "api-ms-win", "vcruntime", "msvcp", "ucrtbase", "kernel32", "ntdll",
            "windows", "microsoft", "system32", "syswow64", "winsxs",
            "dotnet", "aspnet", "clr", "coreclr", "hostfxr",
            "qt", "gtk", "wxwidgets", "electron", "chromium", "firefox", "edge",
            "nvidia", "amd", "intel", "realtek",
            "steam", "epic", "origin", "uplay", "gog",
            "adobe", "autodesk", "unity", "unreal",
            "python", "java", "node", "npm", "yarn",
            "git", "svn", "mercurial",
            "visualstudio", "vscode", "jetbrains", "rider", "idea",
            "office", "word", "excel", "powerpoint", "outlook",
            "discord", "slack", "teams", "zoom", "skype",
            "spotify", "vlc", "obs", "audacity",
            "7zip", "winrar", "peazip",
            "notepad", "sublime", "atom",
        };

        // Suspicious patterns - must be STANDALONE words, not part of other words
        // These are patterns that indicate actual malware when they appear as the main filename
        private static readonly string[] StandaloneSuspiciousNames = new[]
        {
            "crack.exe", "keygen.exe", "patch.exe", "activator.exe",
            "hack.exe", "cheat.exe", "aimbot.exe", "wallhack.exe",
            "trojan.exe", "virus.exe", "malware.exe", "backdoor.exe", "rootkit.exe",
            "keylogger.exe", "stealer.exe", "grabber.exe", "rat.exe",
            "cryptominer.exe", "miner.exe",
        };

        // Adware installer names - exact matches
        private static readonly HashSet<string> AdwareInstallers = new(StringComparer.OrdinalIgnoreCase)
        {
            "opencandy", "installcore", "softonic_downloader", 
            "mindspark", "mywebsearch", "funmoods",
            "conduit", "babylon_toolbar", "ask_toolbar",
            "sweetim", "iminent", "wajam", "superfish",
        };

        // Public adware signatures for browser extension checking
        public static readonly HashSet<string> AdwareSignatures = new(StringComparer.OrdinalIgnoreCase)
        {
            "opencandy", "installcore", "softonic",
            "mindspark", "mywebsearch", "funmoods",
            "conduit", "babylon", "ask toolbar",
            "sweetim", "iminent", "wajam", "superfish",
            "dealply", "pricegong", "shopperz",
        };

        /// <summary>
        /// Calculate SHA256 hash of a file
        /// </summary>
        public static string GetFileHash(string filePath)
        {
            try
            {
                using var sha256 = SHA256.Create();
                using var stream = File.OpenRead(filePath);
                var hash = sha256.ComputeHash(stream);
                return BitConverter.ToString(hash).Replace("-", "").ToLower();
            }
            catch
            {
                return string.Empty;
            }
        }

        /// <summary>
        /// Check if file matches known malware hash
        /// </summary>
        public static bool IsKnownMalware(string hash)
        {
            return !string.IsNullOrEmpty(hash) && KnownMalwareHashes.Contains(hash);
        }

        /// <summary>
        /// Check if filename is suspicious - SMART detection that avoids false positives
        /// </summary>
        public static (bool IsSuspicious, string Pattern) CheckFileName(string fileName)
        {
            var lower = fileName.ToLower();
            
            // First check whitelist - if it matches any whitelist pattern, it's safe
            foreach (var safe in WhitelistPatterns)
            {
                if (lower.Contains(safe))
                    return (false, string.Empty);
            }

            // Check for exact suspicious filenames
            foreach (var suspicious in StandaloneSuspiciousNames)
            {
                if (lower == suspicious || lower.EndsWith("_" + suspicious) || lower.EndsWith("-" + suspicious))
                    return (true, suspicious);
            }

            // Check for adware installers
            foreach (var adware in AdwareInstallers)
            {
                if (lower.Contains(adware))
                    return (true, $"Adware: {adware}");
            }

            // Check for suspicious naming patterns (standalone words only)
            // e.g., "game_crack.exe" but NOT "api-ms-win-core-libraryloader.dll"
            var nameParts = lower.Replace("-", "_").Replace(".", "_").Split('_');
            foreach (var part in nameParts)
            {
                if (part == "crack" || part == "keygen" || part == "activator" || 
                    part == "hack" || part == "cheat" || part == "aimbot" ||
                    part == "trojan" || part == "virus" || part == "malware" ||
                    part == "keylogger" || part == "stealer" || part == "cryptominer")
                {
                    return (true, part);
                }
            }

            return (false, string.Empty);
        }

        /// <summary>
        /// Check if process name is known malware - EXACT match only
        /// </summary>
        public static bool IsMalwareProcess(string processName)
        {
            var lower = processName.ToLower().Replace(".exe", "");
            return MalwareProcessNames.Contains(lower);
        }
    }
}
